<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST FINAL - BURBUJA FIX</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: white;}

        #botlode-wrapper { position: fixed; bottom: 35px; right: 35px; z-index: 9999; }
        
        #backdrop {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            display: none; z-index: 9998;
        }

        #botlode-iframe { 
            position: absolute; 
            width: 450px; 
            height: 750px; 
            max-height: 85vh; 
            bottom: -40px; 
            right: -40px; 
            border: none; 
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
            /* EMPEZAMOS EN NONE (FANTASMA) */
            pointer-events: none; 
        }

        #interaction-proxy { position: absolute; bottom: 0; right: 0; width: 72px; height: 72px; border-radius: 50%; cursor: pointer; background: rgba(255, 255, 255, 0.01); pointer-events: auto; }
        
        #botlode-wrapper.expanded #botlode-iframe { 
            width: 400px; 
            bottom: 0; right: 0; 
            pointer-events: auto; /* Cuando abre, siempre activo */
            border-radius: 28px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
        }
        
        #botlode-wrapper.expanded #interaction-proxy { display: none; }
        body.chat-open #backdrop { display: block; }
    </style>
</head>
<body class="">

    <div id="backdrop"></div>

    <div id="botlode-wrapper">
        <iframe 
            id="botlode-iframe" 
            src="https://botlode-player.vercel.app" 
            allow="microphone; clipboard-write"
            allowtransparency="true"
            style="background-color: transparent;"
        ></iframe>
        <div id="interaction-proxy"></div>
    </div>

    <h1>PRUEBA DE BURBUJA</h1>
    <p>Acerca el mouse a la esquina inferior derecha.</p>

    <script>
        const wrapper = document.getElementById('botlode-wrapper');
        const iframe = document.getElementById('botlode-iframe');
        const proxy = document.getElementById('interaction-proxy');
        const backdrop = document.getElementById('backdrop');

        // 1. RASTREO DE MOUSE
        document.addEventListener('mousemove', (e) => {
            iframe.contentWindow.postMessage(`MOUSE_MOVE:${e.clientX},${e.clientY},${window.innerWidth},${window.innerHeight}`, '*');
        });

        // 2. ESCUCHA DE EVENTOS (LA MAGIA)
        window.addEventListener('message', (event) => {
            const cmd = event.data;
            
            if (cmd === 'CMD_CLOSE') closeChat();
            if (cmd === 'CMD_OPEN') openChat();

            // --- SEMÃFORO DE INTERACTIVIDAD ---
            // Si Flutter dice "Entraste a la burbuja", activamos el Iframe para que reciba el click
            if (cmd === 'HOVER_ENTER') {
                if (!wrapper.classList.contains('expanded')) {
                    iframe.style.pointerEvents = 'auto';
                }
            }
            // Si sales, lo volvemos fantasma para poder clickear la web de abajo
            if (cmd === 'HOVER_EXIT') {
                if (!wrapper.classList.contains('expanded')) {
                    iframe.style.pointerEvents = 'none';
                }
            }
        });

        function openChat() {
            wrapper.classList.add('expanded');
            document.body.classList.add('chat-open');
            setTimeout(() => { iframe.contentWindow.postMessage('CMD_OPEN', '*'); }, 100);
        }
        
        // El proxy sigue sirviendo de respaldo
        proxy.addEventListener('click', openChat);

        function closeChat() {
            wrapper.classList.remove('expanded');
            document.body.classList.remove('chat-open');
            iframe.contentWindow.postMessage('CMD_CLOSE', '*');
            // Al cerrar, vuelve a fantasma
            iframe.style.pointerEvents = 'none';
        }
        
        backdrop.addEventListener('click', closeChat);
    </script>
</body>
</html>